<!DOCTYPE html>
<html>

<head>
  <!--https://james2moore.github.io/geo/-->
  <title>Signpost</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <script type="module">
    //所有地点的信息
    const PLACES = [
      {
        "name": "The Webb Schools",
        "boundary": [
          [34.129938, -117.742799, 34.128788, -117.739827],
          [34.128788, -117.742598, 34.127339, -117.736260],
          [34.127339, -117.742472, 34.124354, -117.733227],
          [34.124354, -117.740821, 34.121610, -117.735081]
        ],
        "place": [
          ["Price Dining Hall", 34.1241543, -117.7398563],
          {
            "name": "Library",
            "place": [
              ["Library Door", 34.1238431, -117.7390556],
              ["Library Room North, 3, South", 34.1239534, -117.7388547],
              ["Library Room 2", 34.1240165, -117.7387937],
            ]
          }
        ]
      },
      {
        "name": "La Verne Towne Center",
        "boundary": [
          [34.113511, -117.763343, 34.107986, -117.757244]
        ],
        "place": [
          ["Parking lot entrance and exit", 34.111508, -117.760086],
          ['West parking lot', 34.111069, -117.761092],
          ["East parking lot", 34.110423, -117.759410],
          ["Bus station, Stop ID:1347", 34.111779, -117.761104],
          ["Target Grocery", 34.110009, -117.759385],
          ["Staples(Office supply store)", 34.110757, -117.761217],
          ["McDonald's", 34.112866, -117.762204]
        ]
      },
      {
        "name": "Boracay Island",
        "boundary": [
          [11.998052, 121.902291, 11.940964, 121.952756]
        ],
        "place": [
          ["S1 Beach", 11.968732, 121.918694],
          ["S2 Beach", 11.960763, 121.924721],
          ["S3 Beach", 11.953299, 121.929169],
          ["Bulabog Beach", 11.965783, 121.928838],
          {
            "name": "Restaurant",
            "place": [
              ["McDonald's", 11.962948, 121.926563],
              ["The Pig Out Bistro", 11.965298, 121.923524]
            ]
          },
          {
            "name": "Supermarket",
            "place": [
              ["Budget Mart", 11.963232267224607, 121.92638565938344],
              ["Robinsons Supermarket", 11.975197752900698, 121.9184145513564],
              ["CityMall Boracay", 11.979172241037892, 121.92073167663847],
            ]
          }
        ]
      },
    ]//PLACES
    if (navigator.geolocation) {
      /*addEventListener("load", () => {

      })*/
      // Call watchPosition once to start tracking the user location
      let lastCheckPlaceTime = 0//最后检查地点的时间
      let lastPlace//最后显示的地点
      function updatePlace() {
        console.log('updatePlace', lastPlace)
        while (placeList.lastChild) placeList.removeChild(placeList.lastChild)
      }
      navigator.geolocation.watchPosition(position => {
        // Get the raw GPS data
        const lat = position.coords.latitude
        const lng = position.coords.longitude
        const acc = position.coords.accuracy
        const timems = position.timestamp
        if (timems - lastCheckPlaceTime > 3000) {//如果上一次检查已经过去3秒，则再次检查；即每3秒检查一次
          let findPlace//找到的地点
          for (const place of PLACES) {//遍历所有地点
            for (const boundary of place.boundary) {//遍历地点的所有矩形框
              //如果在地点的边界内
              if (lat < boundary[0] && lat > boundary[2] && lng > boundary[1] && lng < boundary[3]) {
                //note:lat左上角比右下角数值大
                //如果最后显示的地点不是此地点，则表示进入了某地点
                findPlace = place
                break
              }
            }//for boundary
            if (findPlace) break//如果已找到地点，则强制结束
          }//for place
          lastCheckPlaceTime = timems//更新检查时间
          if (lastPlace != findPlace) {
            lastPlace = findPlace
            updatePlace()
          }
        }
      }, error => {
        errorText.textContent = `Error getting user location: ${error}`
      }, {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      })
    } else {
      errorText.textContent = 'Geolocation is not supported by this browser.'
    }

  </script>
</head>

<body>
  <h1>12345</h1>
  <div id="placeList">
    <p>nc</p>
    <p>h3</p>
  </div>
  <h2 id="errorText"></h2>
</body>

</html>